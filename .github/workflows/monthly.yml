name: monthly-newsletter

on:
  schedule:
    - cron: '0 7 1 * *'   # 07:00 UTC == 09:00 Europe/Paris on the 1st
  workflow_dispatch: {}

env:
  TZ: Europe/Paris
  SUBSTACK_STATUS: draft   # change to 'publish' to auto-send

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright
        run: |
          pip install playwright==1.47.0
          playwright install --with-deps chromium

      - name: Collect sources
        run: |
          mkdir -p data
          python -m src.collect_sources
          echo "DATA_JSON=$(ls -1t data/collected_*.json | head -n1)" >> $GITHUB_ENV

      - name: Generate with Mistral
        env:
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        run: |
          python -m src.generate_issue "$DATA_JSON" out

      - name: Publish to Substack via Playwright (full auto)
        env:
          SUBSTACK_BASE_URL: ${{ secrets.SUBSTACK_BASE_URL }}
          SUBSTACK_EMAIL: ${{ secrets.SUBSTACK_EMAIL }}
          SUBSTACK_PASSWORD: ${{ secrets.SUBSTACK_PASSWORD }}
        run: |
          python publish_via_playwright.py out/newsletter_post.html "Art de Vivre Durable — $(date +'%B %Y')" "${{ env.SUBSTACK_STATUS }}"

        run: |
          python -m src.publish_substack out/newsletter_post.html "Art de Vivre Durable — $(date +'%B %Y')" "${{ env.SUBSTACK_STATUS }}"
